---
date: 2024-07-10
id: logging
title: Cloud Functions Logging
hide_table_of_contents: true
---


## Overview

This documentation provides a detailed walkthrough on how to set up a Google Cloud Function to send the logs directly to SigNoz. By the end of this guide, you will have a setup that automatically sends your Cloud Function logs to SigNoz.

<Tabs>
<TabItem value="cloud" label="SigNoz Cloud" default>

**Here's a quick summary of what we will be doing in this guide**

* Create and configure a Cloud Function
* Invoke the Cloud Function using Trigger
* Send and Visualize the logs in SigNoz Cloud

## Prerequisites


* [Google Cloud account](https://console.cloud.google.com/) with administrative privilege or Cloud Functions Admin privilege.
* [SigNoz Cloud Account](https://signoz.io/teams/) (we are using SigNoz Cloud for this demonstration, we will also need ingestion details. To get your **Ingestion Key** and **Ingestion URL,** sign-in to your SigNoz Cloud Account and go to **Settings** >> **Ingestion Settings**)
* Access to a project in GCP
* Google Cloud Functions APIs enabled (follow [this](https://support.google.com/googleapi/answer/6158841?hl=en) guide to see how to enable an API in Google Cloud)


## Setup


### Get started with Cloud Function Configuration

Follow these steps to create the Cloud Function:

Step 1: Go to your GCP console and search for Cloud Functions, go to Functions and click on **CREATE FUNCTION**.


<figure data-zoomable align="left">
    <img
        src="/img/docs/gcp-monitoring/cloud-logs/cloud-function.webp"
        alt="GCP Cloud Function"
    />
<figcaption>
<i>
GCP Cloud Functions
</i>
</figcaption>
</figure>


Step 2: Fill in the following details to create a Cloud Function:



1. Environment: 2nd gen
2. Function name: Name for the Cloud Function
3. Region: Takes the default region of the GCP account
4. Trigger: Defines how to trigger the Cloud Function
    1. Trigger Type: HTTPS - this allows us to trigger the Cloud Function using a URL
    2. Authentication: Choose whether you need authenticated or unauthenticated invocations. We have chosen unauthenticated invocation for this demonstration.

<figure data-zoomable align="left">
    <img
        src="/img/docs/gcp-monitoring/cloud-logs/create-function.webp"
        alt="Create Cloud function"
    />
<figcaption>
<i>
Create Cloud Function
</i>
</figcaption>
</figure>


Step 3: Expand the **Runtime, build, connections, and security settings** section, and under **Runtime environment variables:**

Add `SIGNOZ_ACCESS_TOKEN` and `SIGNOZ_HTTP_URL` with **Ingestion Key** and **Ingestion URL** respectively. You can get Ingestion Key and Ingestion URL.


<figure data-zoomable align="left">
    <img
        src="/img/docs/gcp-monitoring/cloud-logs/runtime-variables.webp"
        alt="Cloud Function Runtime Environment Variables"
    />
<figcaption>
<i>
Set Cloud Function Runtime Environment Variables
</i>
</figcaption>
</figure>

Step 4: Click on the **NEXT** button, which will bring us to the page where we can add our code.

<figure data-zoomable align="left">
    <img
        src="/img/docs/gcp-monitoring/cloud-logs/entrypoint.webp"
        alt="Runtime and Entry Point of Cloud Function"
    />
<figcaption>
<i>
Set entrypoint and source code
</i>
</figcaption>
</figure>

### Add code to the Google Cloud Function

For this demonstration, we will be using Python 3.10.

Below is the comprehensive code of the `main.py` file, followed by a high level overview of what the code is doing.

```python
import functions_framework
from os import environ
import requests
import json
from datetime import datetime
import random
from time import sleep

def write_log(log_data, trace_id):

    sleep(1)

    print("Sending the log to SigNoz...")
    print(f"log_data: {log_data}")

    req_headers = {

         ‘signoz-access-token': environ.get(‘SIGNOZ_ACCESS_TOKEN’),
         'Content-Type': 'application/json'

    }

    data = [{

      "timestamp": int(datetime.now().timestamp()),
      "trace_id": f"{trace_id}",
      "severity_text": "info",
      "severity_number": 5,
      "resources": {

        "resource-type": "gcloud-function",
        "resource-name": "function-3",
        "resource-region": "asia-south-1"

      },

      "body": log_data,

    }]

    # Specify the HTTP endpoint for sending the data

    http_url = environ.get('SIGNOZ_HTTP_URL')
    response = requests.post(http_url, data=json.dumps(data), headers=req_headers)

    if not response.status_code == 200:

        print("Failed to send the log to SigNoz.")
        print(response.text)

    else:
        print("Sent the log to SigNoz successfully.")

@functions_framework.http

def hello_http(request):

    epoch_string = f"{int(datetime.now().timestamp())}"

    if len(epoch_string)%2 == 0:
        random_hex_string = ''.join(random.choices('0123456789abcdef', k=8))

    else:
        random_hex_string = ''.join(random.choices('0123456789abcdef', k=7))

    trace_id = f"{epoch_string}{random_hex_string}"

    write_log("Initializing Function...", trace_id)


    request_json = request.get_json(silent=True)
    request_args = request.args

    if request_json and 'name' in request_json:
        name = request_json['name']
        write_log("name is in request_json", trace_id)

    elif request_args and 'name' in request_args:
        name = request_args['name']
        write_log("name is in request_args", trace_id)

    else:
        write_log("No name found.", trace_id)
        name = 'World'

    write_log("Sending response...", trace_id)

    return 'Hello {}!'.format(name)
```

Below is a high-level overview of the above code snippet:



* **hello_http(request)**: Handles incoming HTTP requests, extracts 'name' from the request, and logs various stages of execution.
* **@funtions_framework.http**: Decorator that defines `hello_http` as an HTTP handler for Google Cloud Functions.
* **write_log(log_data, trace_id)**: Sends log data to SigNoz using an HTTP POST request with appropriate headers and log structure.
* The code creates an even length string consisting of the current timestamp followed by a hex string at the beginning and uses it as a unique `trace_id` for log entries and returns a greeting message.

To install the required packages, add a requirements.txt file to the source with the following content: 

```txt
functions-framework==3.*
requests

```

The requirements.txt file should contain all the external Python libraries and packages that your Cloud Function depends upon. This file is used by Google Cloud Function to create an environment with all the required packages.

Once you’ve finished writing your code, locate the **DEPLOY** button. After clicking the **DEPLOY** button, Google Cloud Function initiates deployment, starts provisioning the function according to the specified configuration, initializes the environment, handles dependencies, and makes the function ready to handle incoming requests.


## Testing your cloud function

Step 1: After completing the deployment, navigate to the **TRIGGER** section to obtain the URL to invoke the function.


<figure data-zoomable align="left">
    <img
        src="/img/docs/gcp-monitoring/cloud-logs/deploying-function.webp"
        alt="Deploying Function"
    />
<figcaption>
<i>
Deploying Cloud Function
</i>
</figcaption>
</figure>


Step 2: Hit the URL that you have obtained, you will see the function output.

<figure data-zoomable align="left">
    <img
        src="/img/docs/gcp-monitoring/cloud-logs/cloud-function-url.webp"
        alt="Cloud Function URL"
    />
<figcaption>
<i>
Cloud function URL.
</i>
</figcaption>
</figure>


Step 3: Click on the **LOGS** section in your Cloud Function to view the logs, which will indicate that the log has been sent to SigNoz successfully.

<figure data-zoomable align="left">
    <img
        src="/img/docs/gcp-monitoring/cloud-logs/function-logs.webp"
        alt="Cloud Function Logs"
    />
<figcaption>
<i>
Viewing Cloud Function Logs
</i>
</figcaption>
</figure>


## Visualize the logs in SigNoz Cloud

Go to your SigNoz UI, and navigate to the SigNoz dashboard. Click on the **Logs** section to view the logs.


**Note**: If you have multiple applications already sending logs to SigNoz, you can check by adding `resource-type`, `resource-name`, and `resource-region` filters in the Search filters field. Put the values that we used in the payload in the `write_log` function of our Cloud Function.

<figure data-zoomable align="left">
    <img
        src="/img/docs/gcp-monitoring/cloud-logs/signoz-dashboard.webp"
        alt="SigNoz Dashboard"
    />
<figcaption>
<i>
SigNoz Dashboard
</i>
</figcaption>
</figure>

That's it! You have successfully set up monitoring for your Cloud Function's logs with SigNoz Cloud.


## Troubleshooting

If you encounter any issues while setting up monitoring for your Cloud Function's logs with SigNoz, here are a few troubleshooting steps you can try:

* Verify that your Cloud Function instance is running and accessible.
* Ensure that you have the necessary permissions to access the logs in your function.
* Check and mention the correct URL of the SigNoz Cloud account and the Ingestion(token) key.

By following this guide, you should be able to easily send the logs of your Google Cloud Function's system to SigNoz and gain valuable insights in case there is some issue.

</TabItem>

<TabItem value="self-host" label="Self-Host">

**Here's a quick summary of what we will be doing in this guide**

* Create and configure a Cloud Function
* Invoke the Cloud Function using Trigger
* Send and Visualize the logs in Self-Hosted SigNoz


## Prerequisites

* [Google Cloud account](https://console.cloud.google.com/) with administrative privilege or Cloud Functions Admin privilege.
* Access to a project in GCP
* Google Cloud Functions APIs enabled (follow [this](https://support.google.com/googleapi/answer/6158841?hl=en) guide to see how to enable an API in Google Cloud)
* [Self-Host SigNoz](https://signoz.io/docs/install/docker/) 

<Admonition type="info">
For more details on how to configure Self-Hosted SigNoz for Logs, check [official documentation by Self-Hosted SigNoz](https://signoz.io/docs/userguide/send-logs-http/#send-logs-to-self-hosted-signoz) and navigate to the "Send Logs to Self-Hosted SigNoz" section
</Admonition>

## Setup

### Get started with Cloud Function Configuration

Follow these steps to create the Cloud Function:

Step 1: Go to your GCP console and search for Cloud Functions, go to Functions and click on **CREATE FUNCTION**.


<figure data-zoomable align="left">
    <img
        src="/img/docs/gcp-monitoring/self-hosted-logs/cloud-function.webp"
        alt="GCP Cloud Function"
    />
<figcaption>
<i>
GCP Cloud Functions
</i>
</figcaption>
</figure>


Step 2: Fill in the following details to create a Cloud Function:

1. Environment: 2nd gen
2. Function name: Name for the Cloud Function
3. Region: Takes the default region of the GCP account
4. Trigger: Defines how to trigger the Cloud Function
    1. Trigger Type: HTTPS - this allows us to trigger the Cloud Function using a URL
    2. Authentication: Choose whether you need authenticated or unauthenticated invocations. We have chosen unauthenticated invocation for this demonstration.

<figure data-zoomable align="left">
    <img
        src="/img/docs/gcp-monitoring/self-hosted-logs/create-function.webp"
        alt="Create Cloud function"
    />
<figcaption>
<i>
Create Cloud Function
</i>
</figcaption>
</figure>

Step 3: Expand the **Runtime, build, connections, and security settings** section, and under **Runtime environment variables:**

ADD `Self-Hosted SIGNOZ_HTTP_URL` The SigNoz endpoint would be `http://<Self-Hosted SigNoz-host-ip>:8082` however, the URL can differ based on how you set up the infrastructure.


<figure data-zoomable align="left">
    <img
        src="/img/docs/gcp-monitoring/self-hosted-logs/runtime-variables.webp"
        alt="Cloud Function Runtime Environment Variables"
    />
<figcaption>
<i>
Set Cloud Function Runtime Environment Variables
</i>
</figcaption>
</figure>

Step 4: Click on the **NEXT** button, which will bring us to the page where we can add our code.

<figure data-zoomable align="left">
    <img
        src="/img/docs/gcp-monitoring/self-hosted-logs/entrypoint.webp"
        alt="Runtime and Entry Point of Cloud Function"
    />
<figcaption>
<i>
Set entrypoint and source code
</i>
</figcaption>
</figure>

### Add code to the Google Cloud Function

For this demonstration, we will be using Python 3.10.

Below is the comprehensive code of the `main.py` file, followed by a high level overview of what the code is doing.


```python
import functions_framework
from os import environ
import requests
import json
from datetime import datetime
import random

def write_log(log_data, trace_id):
   print("Sending the log to SigNoz...")
   print(f"log_data: {log_data}")

   req_headers = {
       'Content-Type': 'application/json'
   }

   data = [{
       "timestamp": int(datetime.now().timestamp()),
       "trace_id": f"{trace_id}",
       "severity_text": "info",
       "severity_number": 5,
       "resources": {
           "resource-type": "gcloud-function",
           "resource-name": "function-3",
           "resource-region": "asia-south-1"
       },
       "body": log_data,
   }]


   # Specify the HTTP endpoint for sending the data
   http_url = environ.get('SIGNOZ_HTTP_URL')
   print(f"HTTP URL: {http_url}")  # Debug statement to verify the URL


   response = requests.post(http_url, data=json.dumps(data), headers=req_headers)

   if response.status_code != 200:
       print("Failed to send the log to SigNoz.")
       print(f"Status Code: {response.status_code}")
       print(response.text)
   else:
       print("Sent the log to SigNoz successfully.")

@functions_framework.http
def hello_http(request):
   epoch_string = f"{int(datetime.now().timestamp())}"
   if len(epoch_string) % 2 == 0:
       random_hex_string = ''.join(random.choices('0123456789abcdef', k=8))
   else:
       random_hex_string = ''.join(random.choices('0123456789abcdef', k=7))
   trace_id = f"{epoch_string}{random_hex_string}"
   write_log("Initializing Function...", trace_id)


   request_json = request.get_json(silent=True)
   request_args = request.args

   if request_json and 'name' in request_json:
       name = request_json['name']
       write_log("name is in request_json", trace_id)
   elif request_args and 'name' in request_args:
       name = request_args['name']
       write_log("name is in request_args", trace_id)
   else:
       write_log("No name found.", trace_id)
       name = 'World'


   write_log("Sending response...", trace_id)
   return 'Hello {}!'.format(name)
```

Below is a high-level overview of the above code snippet:

* **hello_http(request)**: Handles incoming HTTP requests, extracts 'name' from the request, and logs various stages of execution.
* **@funtions_framework.http**: Decorator that defines `hello_http` as an HTTP handler for Google Cloud Functions.
* **write_log(log_data, trace_id)**: Sends log data to Self-Hosted SigNoz using an HTTP POST request with appropriate headers and log structure.
* The code creates an even length string consisting of the current timestamp followed by a hex string at the beginning and uses it as a unique `trace_id` for log entries and returns a greeting message.

To install the required packages, add a requirements.txt file to the source with the following content: 

```txt
functions-framework==3.*
requests
```

The requirements.txt file should contain all the external Python libraries and packages that your Cloud Function depends upon. This file is used by Google Cloud Function to create an environment with all the required packages.

Once you've finished writing your code, locate the **DEPLOY** button. After clicking the **DEPLOY** button, Google Cloud Function initiates deployment, starts provisioning the function according to the specified configuration, initializes the environment, handles dependencies, and makes the function ready to handle incoming requests.


## Testing your cloud function

Step 1: After completing the deployment, navigate to the **TRIGGER** section to obtain the URL to invoke the function.

<figure data-zoomable align="left">
    <img
        src="/img/docs/gcp-monitoring/self-hosted-logs/deploying-function.webp"
        alt="Deploying Function"
    />
<figcaption>
<i>
Deploying Cloud Function
</i>
</figcaption>
</figure>

Step 2: Hit the URL that you have obtained, you will see the function output.

<figure data-zoomable align="left">
    <img
        src="/img/docs/gcp-monitoring/self-hosted-logs/cloud-function-url.webp"
        alt="Cloud Function URL"
    />
<figcaption>
<i>
Cloud function URL.
</i>
</figcaption>
</figure>

Step 3: Click on the **LOGS** section in your Cloud Function to view the logs, which will indicate that the log has been sent to Self-Hosted SigNoz successfully.

<figure data-zoomable align="left">
    <img
        src="/img/docs/gcp-monitoring/self-hosted-logs/function-logs.webp"
        alt="Cloud Function Logs"
    />
<figcaption>
<i>
Viewing Cloud Function Logs
</i>
</figcaption>
</figure>

## Visualize the logs in Self-Hosted SigNoz

Go to your Self-Hosted SigNoz UI, and navigate to the Self-Hosted SigNoz dashboard. Click on the **Logs** section to view the logs. The default Self-Hosted SigNoz dashboard endpoint would be `http://<Self-Hosted SigNoz-host-ip>:3301`.

**Note**: If you have multiple applications already sending logs to Self-Hosted SigNoz, you can check by adding `resource-type`, `resource-name`, and `resource-region` filters in the Search filters field. Put the values that we used in the payload in the `write_log` function of our Cloud Function.


<figure data-zoomable align="left">
    <img
        src="/img/docs/gcp-monitoring/self-hosted-logs/signoz-dashboard.webp"
        alt="SigNoz Dashboard"
    />
<figcaption>
<i>
SigNoz Dashboard
</i>
</figcaption>
</figure>


That's it! You have successfully set up monitoring for your Cloud Function's logs with Self-Hosted SigNoz.


## Troubleshooting

If you encounter any issues while setting up monitoring for your Cloud Function's logs with Self-Hosted SigNoz, here are a few troubleshooting steps you can try:

* Verify that your Cloud Function instance is running and accessible.
* Ensure that you have the necessary permissions to access the logs in your function.
* Check and mention the correct URL of the Self-Hosted SigNoz Self-Host, OTEL configuration, and routing.

By following this guide, you should be able to easily send the logs of your Google Cloud Function's system to Self-Hosted SigNoz and gain valuable insights in case there is some issue.

</TabItem>
</Tabs>
