---
date: 2024-08-20
id: nextjs
title: Nextjs OpenTelemetry Instrumentation
description:  Learn how to instrument your Nextjs application with OpenTelemetry and send telemetry data to SigNoz
hide_table_of_contents: true
---
This document contains instructions on how to set up OpenTelemetry instrumentation in your Nextjs applications and view your application traces in SigNoz.

{/* 
This document contains instructions on how to set up OpenTelemetry instrumentation in your Nextjs applications. OpenTelemetry, also known as OTel for short, is an open source observability framework that can help you generate and collect telemetry data - traces, metrics, and logs from your Nextjs application. */}

<Tabs entityName="plans">
<TabItem value="signoz-cloud" label="SigNoz Cloud" default>
## Send traces to SigNoz Cloud

Based on your application environment, you can choose the setup below to send traces to SigNoz Cloud.

<Tabs>
<TabItem value="vm" label="VM" default>

From VMs, there are two ways to send data to SigNoz Cloud.

- Send traces directly to SigNoz Cloud
  - [Using vercel otel](#using-vercel-otel) (recommended)
  - [OpenTelemetry instrument (only works for nodejs runtime)](#using-opentelemetry-instrument-only-works-for-nodejs-runtime)
- Send traces via OTel Collector binary (recommended)
  - [Using vercel otel](#using-vercel-otel-1) (recommended)
  - [OpenTelemetry instrument (only works for nodejs runtime)](#using-opentelemetry-instrument-only-works-for-nodejs-runtime-1)

### Send traces directly to SigNoz Cloud

#### Using vercel otel

**Step 1.** Install OpenTelemetry packages

```bash
npm install @vercel/otel @opentelemetry/sdk-logs @opentelemetry/api-logs @opentelemetry/instrumentation @opentelemetry/exporter-trace-otlp-http
```

**Step 2.** Update `next.config.mjs` to include instrumentationHook
```tsx
/** @type {import('next').NextConfig} */
const nextConfig = {
    // include instrumentationHook experimental feature
    experimental: {
        instrumentationHook: true,
    },
};

export default nextConfig;
```

**Step 3.** Create `instrumentation.node.ts` or `instrumentation.node.ts`  file<br></br>
You need to configure the endpoint for SigNoz cloud in this file.

<Tabs>
<TabItem value="typescript" label="TypeScript" default>

```ts:instrumentation.node.ts
'use strict'
import { OTLPHttpJsonTraceExporter } from '@vercel/otel';

// Add otel logging
import { diag, DiagConsoleLogger, DiagLogLevel } from '@opentelemetry/api';
diag.setLogger(new DiagConsoleLogger(), DiagLogLevel.ERROR); // set diaglog level to DEBUG when debugging

const exporterOptions = {
  url: 'https://ingest.<region>.signoz.cloud:443/v1/traces', // Set your own data region or set to http://localhost:4318/v1/traces if using selfhost SigNoz
  headers: { 'signoz-ingestion-key': '<your-ingestion-key>' }, // Set if you are using SigNoz Cloud
}

export const traceExporter = new OTLPHttpJsonTraceExporter(exporterOptions);
```

- Set the `<region>` to match your SigNoz Cloud [region](https://signoz.io/docs/ingestion/signoz-cloud/overview/#endpoint)
- Replace `<your-ingestion-key>` with your SigNoz [ingestion key](https://signoz.io/docs/ingestion/signoz-cloud/keys/)

**Step 4.** Create `instrumentation.ts` file<br></br>

```ts:instrumentation.ts
import { registerOTel } from '@vercel/otel';
import { traceExporter } from './instrumentation.node';

export function register() {
  registerOTel({
    serviceName: '<service_name>',
    traceExporter: traceExporter,
  });
}
```

- `<service_name>` is name of your service


</TabItem>
<TabItem value="javascript" label="JavaScript">

Create `instrumentation.node.js`:
```js:instrumentation.node.js
'use strict'
const { OTLPTraceExporter } = require('@opentelemetry/exporter-trace-otlp-http');

// Add otel logging
const { diag, DiagConsoleLogger, DiagLogLevel } = require('@opentelemetry/api');
diag.setLogger(new DiagConsoleLogger(), DiagLogLevel.ERROR); // set diaglog level to DEBUG when debugging

const exporterOptions = {
  url: 'https://ingest.<region>.signoz.cloud:443/v1/traces', // Set your own data region or set to http://localhost:4318/v1/traces if using selfhost SigNoz
  headers: { 'signoz-access-token': '<your-ingestion-key>' }, // Set if you are using SigNoz Cloud
}

exports.traceExporter = new OTLPTraceExporter(exporterOptions);
```

- Set the `<region>` to match your SigNoz Cloud [region](https://signoz.io/docs/ingestion/signoz-cloud/overview/#endpoint)
- Replace `<your-ingestion-key>` with your SigNoz [ingestion key](https://signoz.io/docs/ingestion/signoz-cloud/keys/)

Create `instrumentation.js`:
```js:instrumentation.js
const { registerOTel } = require('@vercel/otel');
const { traceExporter } = require('./instrumentation.node');

exports.register = function() {
  registerOTel({
    serviceName: '<service_name>',
    traceExporter: traceExporter,
  });
}
```

- `<service_name>` is name of your service

</TabItem>
</Tabs>

**Step 3.** Once you're done configuring the exporter options, try running your application and validate if your application is sending traces to SigNoz cloud [here](#validating-instrumentation-by-checking-for-traces).

<Admonition>
The instrumentation file should be in the root of your project and not inside the app or pages directory. If you're using the src folder, then place the file inside src alongside pages and app.
</Admonition>

You can also check the sample application at this <a href = "https://github.com/SigNoz/sample-nextjs-app/tree/vercel-otel" rel="noopener noreferrer nofollow" target="_blank">GitHub repo</a>.

#### Using OpenTelemetry instrument (only works for nodejs runtime)

**Step 1.** Install the OpenTelemetry packages

```bash
npm i @opentelemetry/sdk-node
npm i @opentelemetry/auto-instrumentations-node
npm i @opentelemetry/exporter-trace-otlp-http
npm i @opentelemetry/resources
npm i @opentelemetry/semantic-conventions
```

**Step 2.** Update `next.config.mjs` to include instrumentationHook
```tsx
/** @type {import('next').NextConfig} */
const nextConfig = {
    // include instrumentationHook experimental feature
    experimental: {
        instrumentationHook: true,
    },
};

export default nextConfig;
```

<Tabs>
<TabItem value="typescript" label="TypeScript" default>

Create `instrumentation.node.ts`:
```ts:instrumentation.node.ts
'use strict'
import process from 'process';
import {NodeSDK} from '@opentelemetry/sdk-node';
import { getNodeAutoInstrumentations } from '@opentelemetry/auto-instrumentations-node';
import { OTLPTraceExporter } from '@opentelemetry/exporter-trace-otlp-http'
import { Resource } from '@opentelemetry/resources'
import { SEMRESATTRS_SERVICE_NAME } from '@opentelemetry/semantic-conventions'
 
// Add otel logging
import { diag, DiagConsoleLogger, DiagLogLevel } from '@opentelemetry/api';
diag.setLogger(new DiagConsoleLogger(), DiagLogLevel.ERROR); // set diaglog level to DEBUG when debugging

const exporterOptions = {
  url: 'https://ingest.<region>.signoz.cloud:443/v1/traces', // use your own data region 
  headers: { 'signoz-ingestion-key': '<your-ingestion-key>' }, // Use if you are using SigNoz Cloud
}

const traceExporter = new OTLPTraceExporter(exporterOptions);
const sdk = new NodeSDK({
  traceExporter,
  instrumentations: [getNodeAutoInstrumentations()],
    resource: new Resource({
    [SEMRESATTRS_SERVICE_NAME]: '<service_name>',
  }),
});

// initialize the SDK and register with the OpenTelemetry API
// this enables the API to record telemetry
sdk.start()

// gracefully shut down the SDK on process exit
process.on('SIGTERM', () => {
  sdk.shutdown()
    .then(() => console.log('Tracing terminated'))
    .catch((error) => console.log('Error terminating tracing', error))
    .finally(() => process.exit(0));
});
```

Create `instrumentation.ts`:
```ts:instrumentation.ts
export async function register() {
  if (process.env.NEXT_RUNTIME === 'nodejs') {
    await import('./instrumentation.node')
  }
}
```

</TabItem>
<TabItem value="javascript" label="JavaScript">

Create `instrumentation.node.js`:
```js:instrumentation.node.js
'use strict'
const process = require('process');
const {NodeSDK} = require('@opentelemetry/sdk-node');
const { getNodeAutoInstrumentations } = require('@opentelemetry/auto-instrumentations-node');
const { OTLPTraceExporter } = require('@opentelemetry/exporter-trace-otlp-http');
const { Resource } = require('@opentelemetry/resources');
const { SEMRESATTRS_SERVICE_NAME } = require('@opentelemetry/semantic-conventions');
 
// Add otel logging
const { diag, DiagConsoleLogger, DiagLogLevel } = require('@opentelemetry/api');
diag.setLogger(new DiagConsoleLogger(), DiagLogLevel.ERROR); // set diaglog level to DEBUG when debugging

const exporterOptions = {
  url: 'https://ingest.<region>.signoz.cloud:443/v1/traces', // use your own data region 
  headers: { 'signoz-access-token': '<your-ingestion-key>' }, // Use if you are using SigNoz Cloud
}

const traceExporter = new OTLPTraceExporter(exporterOptions);
const sdk = new NodeSDK({
  traceExporter,
  instrumentations: [getNodeAutoInstrumentations()],
    resource: new Resource({
    [SEMRESATTRS_SERVICE_NAME]: '<service_name>',
  }),
});

// initialize the SDK and register with the OpenTelemetry API
// this enables the API to record telemetry
sdk.start()

// gracefully shut down the SDK on process exit
process.on('SIGTERM', () => {
  sdk.shutdown()
    .then(() => console.log('Tracing terminated'))
    .catch((error) => console.log('Error terminating tracing', error))
    .finally(() => process.exit(0));
});
```

- Set the `<region>` to match your SigNoz Cloud [region](https://signoz.io/docs/ingestion/signoz-cloud/overview/#endpoint)
- Replace `<your-ingestion-key>` with your SigNoz [ingestion key](https://signoz.io/docs/ingestion/signoz-cloud/keys/)
- `<service_name>` is name of your service

Create `instrumentation.js`:
```js:instrumentation.js
exports.register = async function() {
  if (process.env.NEXT_RUNTIME === 'nodejs') {
    await require('./instrumentation.node')
  }
}
```

</TabItem>
</Tabs>

- Set the `<region>` to match your SigNoz Cloud [region](https://signoz.io/docs/ingestion/signoz-cloud/overview/#endpoint)
- Replace `<your-ingestion-key>` with your SigNoz [ingestion key](https://signoz.io/docs/ingestion/signoz-cloud/keys/)
- `<service_name>` is name of your service

**Step 3.** Once you're done configuring the exporter options, try running your application and validate if your application is sending traces to SigNoz cloud [here](#validating-instrumentation-by-checking-for-traces).

<Admonition>
The instrumentation file should be in the root of your project and not inside the app or pages directory. If you're using the src folder, then place the file inside src alongside pages and app.
</Admonition>

You can also check the sample application at this <a href = "https://github.com/SigNoz/sample-nextjs-app" rel="noopener noreferrer nofollow" target="_blank">GitHub repo</a>.

### Send traces via OTel Collector binary

OTel Collector binary helps to collect logs, hostmetrics, resource and infra attributes. It is recommended to install Otel Collector binary to collect and send traces to SigNoz cloud. You can correlate signals and have rich contextual data through this way.

<Admonition>
  You can find instructions to install OTel Collector binary
  [here](https://signoz.io/docs/tutorial/opentelemetry-binary-usage-in-virtual-machine/) in your VM.
  Once you are done setting up your OTel Collector binary, you can follow the below steps for
  instrumenting your Javascript application.
</Admonition>


#### Using vercel otel

**Step 1.** Install OpenTelemetry packages

```bash
npm install @vercel/otel @opentelemetry/sdk-logs @opentelemetry/api-logs @opentelemetry/instrumentation @opentelemetry/exporter-trace-otlp-http
```

**Step 2.** Update `next.config.mjs` to include instrumentationHook
```tsx
/** @type {import('next').NextConfig} */
const nextConfig = {
    // include instrumentationHook experimental feature
    experimental: {
        instrumentationHook: true,
    },
};

export default nextConfig;
```

<Tabs>
<TabItem value="typescript" label="TypeScript" default>

Create `instrumentation.node.ts`:
```ts:instrumentation.node.ts
'use strict'
import { OTLPTraceExporter } from '@opentelemetry/exporter-trace-otlp-http';

// Add otel logging
import { diag, DiagConsoleLogger, DiagLogLevel } from '@opentelemetry/api';
diag.setLogger(new DiagConsoleLogger(), DiagLogLevel.ERROR); // set diaglog level to DEBUG when debugging

const exporterOptions = {
  url: 'http://localhost:4318/v1/traces',
}

export const traceExporter = new OTLPTraceExporter(exporterOptions);
```

Create `instrumentation.ts`:
```ts:instrumentation.ts
import { registerOTel } from '@vercel/otel';
import { traceExporter } from './instrumentation.node';

export function register() {
  registerOTel({
    serviceName: '<service_name>',
    traceExporter: traceExporter,
  });
}
```

- `<service_name>` is name of your service

</TabItem>
<TabItem value="javascript" label="JavaScript">

Create `instrumentation.node.js`:
```js:instrumentation.node.js
'use strict'
const { OTLPTraceExporter } = require('@opentelemetry/exporter-trace-otlp-http');

// Add otel logging
const { diag, DiagConsoleLogger, DiagLogLevel } = require('@opentelemetry/api');
diag.setLogger(new DiagConsoleLogger(), DiagLogLevel.ERROR); // set diaglog level to DEBUG when debugging

const exporterOptions = {
  url: 'http://localhost:4318/v1/traces',
}

exports.traceExporter = new OTLPTraceExporter(exporterOptions);
```

Create `instrumentation.js`:
```js:instrumentation.js
const { registerOTel } = require('@vercel/otel');
const { traceExporter } = require('./instrumentation.node');

exports.register = function() {
  registerOTel({
    serviceName: 'Sample Next.js App',
    traceExporter: traceExporter,
  });
}
```

</TabItem>
</Tabs>

**Step 3.** Once you're done configuring the exporter options, try running your application and validate if your application is sending traces to SigNoz cloud [here](#validating-instrumentation-by-checking-for-traces).

<Admonition>
The instrumentation file should be in the root of your project and not inside the app or pages directory. If you're using the src folder, then place the file inside src alongside pages and app.
</Admonition>

You can also check the sample application at this <a href = "https://github.com/SigNoz/sample-nextjs-app/tree/vercel-otel" rel="noopener noreferrer nofollow" target="_blank">GitHub repo</a>.


#### Using OpenTelemetry instrument (only works for nodejs runtime)

**Step 1.** Install OpenTelemetry Collector binary

OTel Collector binary helps to collect logs, hostmetrics, resource and infra attributes. It is recommended to install Otel Collector binary to collect and send traces to SigNoz cloud. You can correlate signals and have rich contextual data through this way.

You can find instructions to install OTel Collector binary [here](https://signoz.io/docs/tutorial/opentelemetry-binary-usage-in-virtual-machine/) in your VM. 

While creating the `config.yaml` during the installation fo the OTel Collector Binary, you need to enable CORS under the receivers section of the config file. This is needed so that you don't get 
CORS error which can hinder sending your Traces to SigNoz Cloud. See the code snippet below to understand how you can enable CORS in your config file:

```yml
      http:
+        cors:
+          allowed_origins:
+            - <Frontend-application-URL>  # URL of your Frontend application. Example -> http://localhost:4200, https://netflix.com etc.
```
`<Frontend-application-URL>` - URL where your frontend application is running. For Example, http://localhost:4200 or https://netflix.com etc.

**NOTE:** Make sure to restart your collector after making the config changes

**Step 2.** Install OpenTelemetry packages

```bash
npm i @opentelemetry/sdk-node
npm i @opentelemetry/auto-instrumentations-node
npm i @opentelemetry/exporter-trace-otlp-http
npm i @opentelemetry/resources
npm i @opentelemetry/semantic-conventions
```
**Step 3.** Update `next.config.mjs` to include instrumentationHook
```tsx
/** @type {import('next').NextConfig} */
const nextConfig = {
    // include instrumentationHook experimental feature
    experimental: {
        instrumentationHook: true,
    },
};

export default nextConfig;
```

<Tabs>
<TabItem value="typescript" label="TypeScript" default>

Create `instrumentation.node.ts`:
```ts:instrumentation.node.ts
'use strict'
import process from 'process';
import {NodeSDK} from '@opentelemetry/sdk-node';
import { getNodeAutoInstrumentations } from '@opentelemetry/auto-instrumentations-node';
import { OTLPTraceExporter } from '@opentelemetry/exporter-trace-otlp-http'
import { Resource } from '@opentelemetry/resources'
import { SEMRESATTRS_SERVICE_NAME } from '@opentelemetry/semantic-conventions'
 
// Add otel logging
import { diag, DiagConsoleLogger, DiagLogLevel } from '@opentelemetry/api';
diag.setLogger(new DiagConsoleLogger(), DiagLogLevel.ERROR); // set diaglog level to DEBUG when debugging

const exporterOptions = {
  url: 'http://localhost:4318/v1/traces',
}

const traceExporter = new OTLPTraceExporter(exporterOptions);
const sdk = new NodeSDK({
  traceExporter,
  instrumentations: [getNodeAutoInstrumentations()],
    resource: new Resource({
    [SEMRESATTRS_SERVICE_NAME]: '<service_name>',
  }),
});

// initialize the SDK and register with the OpenTelemetry API
// this enables the API to record telemetry
sdk.start()

// gracefully shut down the SDK on process exit
process.on('SIGTERM', () => {
  sdk.shutdown()
    .then(() => console.log('Tracing terminated'))
    .catch((error) => console.log('Error terminating tracing', error))
    .finally(() => process.exit(0));
});
```

- `<service_name>` is name of your service

Create `instrumentation.ts`:
```ts:instrumentation.ts
export async function register() {
  if (process.env.NEXT_RUNTIME === 'nodejs') {
    await import('./instrumentation.node')
  }
}
```

</TabItem>
<TabItem value="javascript" label="JavaScript">

Create `instrumentation.node.js`:
```js:instrumentation.node.js
'use strict'
const process = require('process');
const {NodeSDK} = require('@opentelemetry/sdk-node');
const { getNodeAutoInstrumentations } = require('@opentelemetry/auto-instrumentations-node');
const { OTLPTraceExporter } = require('@opentelemetry/exporter-trace-otlp-http');
const { Resource } = require('@opentelemetry/resources');
const { SEMRESATTRS_SERVICE_NAME } = require('@opentelemetry/semantic-conventions');
 
// Add otel logging
const { diag, DiagConsoleLogger, DiagLogLevel } = require('@opentelemetry/api');
diag.setLogger(new DiagConsoleLogger(), DiagLogLevel.ERROR); // set diaglog level to DEBUG when debugging

const exporterOptions = {
  url: 'http://localhost:4318/v1/traces',
}

const traceExporter = new OTLPTraceExporter(exporterOptions);
const sdk = new NodeSDK({
  traceExporter,
  instrumentations: [getNodeAutoInstrumentations()],
    resource: new Resource({
    [SEMRESATTRS_SERVICE_NAME]: '<service_name>',
  }),
});

// initialize the SDK and register with the OpenTelemetry API
// this enables the API to record telemetry
sdk.start()

// gracefully shut down the SDK on process exit
process.on('SIGTERM', () => {
  sdk.shutdown()
    .then(() => console.log('Tracing terminated'))
    .catch((error) => console.log('Error terminating tracing', error))
    .finally(() => process.exit(0));
});
```

- `<service_name>` is the name of your service

Create `instrumentation.js`:
```js:instrumentation.js
exports.register = async function() {
  if (process.env.NEXT_RUNTIME === 'nodejs') {
    await require('./instrumentation.node')
  }
}
```

</TabItem>
</Tabs>

**Step 4.** Once we are done with the above configurations, you can run the collector service with the following command:
```bash
./otelcol-contrib --config ./config.yaml
```

**Step 7.** Start running your application and wait for few seconds to start receiving instrumentation data on the SigNoz Cloud. 

<Admonition>
The instrumentation file should be in the root of your project and not inside the app or pages directory. If you're using the src folder, then place the file inside src alongside pages and app.
</Admonition>

You can also check the sample application at this <a href = "https://github.com/SigNoz/sample-nextjs-app" rel="noopener noreferrer nofollow" target="_blank">GitHub repo</a>.

</TabItem>

<TabItem value="k8s" label="Kubernetes">
You can auto-instrument sending traces from Nextjs application using one of the following methods:

1. Using Kubernetes OTel Operator (recommended)
2. Using OTel Collector Agent

<Tabs>
<TabItem value="k8s-otel-operator" label="K8s OTel Operator" default>
### K8s OTel Operator Based Automatic Instrumentation (recommended)

#### Send traces directly to SigNoz Cloud - Using K8s OTel Operator

For Nextjs application deployed on Kubernetes, you can auto-instrument the traces using Kubernetes OpenTelemetry Operator. 

An [OpenTelemetry Operator](https://opentelemetry.io/docs/kubernetes/operator) is a Kubernetes Operator that manages 
[OpenTelemetry Collectors](https://signoz.io/blog/opentelemetry-collector-complete-guide/) and auto-instrumentation of 
workloads. It basically simplifies the deployment and management of OpenTelemetry in a Kubernetes environment.

The OpenTelemetry Operator provides two Custom Resource Definitions (CRDs):

- `OpenTelemetryCollector`
- `Instrumentation`

The `OpenTelemetryCollector` CRD allows you to deploy and manage OpenTelemetry Collectors in your Kubernetes cluster.

The `Instrumentation` CRD allows you to configure and inject OpenTelemetry auto-instrumentation libraries into your workloads.

Here are the steps you need to follow to auto-instrument Nextjs application using OTel Operator:

**Step 1.** Install cert-manager

Run the following commands to apply cert manager.

```bash
kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.16.1/cert-manager.yaml

kubectl wait --for=condition=Available deployments/cert-manager -n cert-manager
```

**Step 2.** Install OpenTelemetry Operator

To install the operator in the existing K8s cluster, run the following command:

```bash
kubectl apply -f https://github.com/open-telemetry/opentelemetry-operator/releases/download/v0.116.0/opentelemetry-operator.yaml
```

Installing the OpenTelemetry Operator sets up the necessary components and configurations to enable the observability and monitoring of applications running in the cluster.

**Step 3.** Setup the OpenTelemetry Collector instance

Once the `opentelemetry-operator` has been deployed, you can proceed with the creation of the OpenTelemetry Collector (`otelcol`) instance. The OpenTelemetry Collector collects, processes, and exports telemetry data.

There are different deployment modes for the `OpenTelemetryCollector`, and you can specify them in the spec.mode section of the custom resource. The available deployment modes are:

- [Daemonset](https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/)
- [Sidecar](https://kubernetes.io/docs/concepts/workloads/pods/sidecar-containers/)
- [StatefulSet](https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/)
- [Deployment](https://kubernetes.io/docs/concepts/workloads/controllers/deployment/) (default mode)

The default method - the `Deployment` mode, will be used here.

To create a simple instance of the OpenTelemetry Collector, create a file `otel-collector.yaml` with the following contents:

```yaml:otel-collector.yaml
apiVersion: opentelemetry.io/v1alpha1
kind: OpenTelemetryCollector
metadata:
  name: otel-collector
spec:
  mode: deployment
  config: |
    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317
          http:
            endpoint: 0.0.0.0:4318
    processors:
      batch: {}
    exporters:
      debug: {}
      otlp:
        endpoint: "ingest.<region>.signoz.cloud:443" # replace <region> with your region of SigNoz Cloud
        tls:
          insecure: false
        headers:
          "signoz-ingestion-key": "<your-ingestion-key>" # Obtain from https://{your-signoz-tenant-url}/settings/ingestion-settings
    service:
      pipelines:
        traces:
          receivers: [otlp]
          processors: [batch]
          exporters: [otlp]
```

- Set the `<region>` to match your SigNoz Cloud [region](https://signoz.io/docs/ingestion/signoz-cloud/overview/#endpoint)
- Replace `<your-ingestion-key>` with your SigNoz [ingestion key](https://signoz.io/docs/ingestion/signoz-cloud/keys/)

Apply the above yaml file using the following command:

```bash
kubectl apply -f otel-collector.yaml
```

**Step 4.** Setup the Instrumentation instance

Once the OpenTelemetry Collector instance has been deployed, the next step will be to create an instrumentation instance, which will be responsible for sending OTLP data to the OTel Collector.

Create a file `instrumentation.yaml` with the following contents:

```yaml:instrumentation.yaml
apiVersion: opentelemetry.io/v1alpha1
kind: Instrumentation
metadata:
  name: traces-instrumentation
spec:
  exporter:
    endpoint: https://ingest.<region>.signoz.cloud:443  # replace <region> with your region of SigNoz Cloud
  env:
    - name: OTEL_EXPORTER_OTLP_HEADERS
      value: signoz-ingestion-key="<signoz-token>"  # Obtain from https://{your-signoz-url}/settings/ingestion-settings
    - name: OTEL_EXPORTER_OTLP_INSECURE
      value: "false"
  propagators:
    - tracecontext
    - baggage
    - b3
  sampler:
    type: parentbased_traceidratio
    argument: "1"
  nodejs:
    image: ghcr.io/open-telemetry/opentelemetry-operator/autoinstrumentation-nodejs:latest
```

Apply the above instrumentation using the following command:

```bash
kubectl apply -f instrumentation.yaml
```

**Step 5.** Auto-instrument your Nextjs app with OpenTelemetry

Create `deployment.yaml` file for your Nextjs application as follows:

```yaml:deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nextjs-app
spec:
  selector:
    matchLabels:
      app: nextjs-app
  replicas: 1
  template:
    metadata:
      labels:
        app: nextjs-app
      annotations:
        instrumentation.opentelemetry.io/inject-nodejs: "true"
        resource.opentelemetry.io/service.name: "nextjs-app"
    spec:
      containers:
      - name: app
        image: nextjs-app:latest
        ports:
        - containerPort: 8080
```

It is important to add the following annotation under `spec > template > metadata > annotations`:

```
instrumentation.opentelemetry.io/inject-nodejs: "true"`
```

This helps in auto-instrumenting the traces from the Nextjs application.

Apply the deployment using the following command:

```bash
kubectl apply -f deployment.yaml
```

With this, the auto-instrumentation of traces for Nextjs application is ready.

**Step 6.** Running the Nextjs application

In order to run the application on port 8080, run the following commands:

```bash
export POD_NAME=$(kubectl get pod -l app=<service-name> -o jsonpath="{.items[0].metadata.name}")  # service name is `nextjs-app` in this case.   

kubectl port-forward ${POD_NAME} 8080:8080
```

You can now access the application on port 8080.

You can validate if your application is sending traces to SigNoz cloud [here](#validating-instrumentation-by-checking-for-traces).

In case you encounter an issue where all applications do not get listed in the services section then please refer to the [troubleshooting section](#troubleshooting-your-installation).

</TabItem>
<TabItem value="otel-collector-agent" label="OTel Collector Agent">
For Nextjs application deployed on Kubernetes, you need to install OTel Collector agent in your k8s infra to collect and send traces to SigNoz Cloud. You can find the instructions to install OTel Collector agent [here](https://signoz.io/docs/tutorial/kubernetes-infra-metrics/).

Once you have set up OTel Collector agent, you can proceed with OpenTelemetry Javascript instrumentation by following either of the two:

1. [Using Vercel OTel Automatic Instrumentation](#using-vercel-otel-2)
2. [Using OpenTelemetry Automatic Instrumentation](#using-opentelemetry-instrument-only-works-for-nodejs-runtime-2)


#### Using Vercel OTel

**Step 1.** Install OpenTelemetry packages

```bash
npm install @vercel/otel @opentelemetry/sdk-logs @opentelemetry/api-logs @opentelemetry/instrumentation @opentelemetry/exporter-trace-otlp-http
```

**Step 2.** Update `next.config.mjs` to include instrumentationHook
```tsx
/** @type {import('next').NextConfig} */
const nextConfig = {
    // include instrumentationHook experimental feature
    experimental: {
        instrumentationHook: true,
    },
};

export default nextConfig;
```

<Tabs>
<TabItem value="typescript" label="TypeScript" default>

Create `instrumentation.node.ts`:
```ts:instrumentation.node.ts
'use strict'
import { OTLPTraceExporter } from '@opentelemetry/exporter-trace-otlp-http';

// Add otel logging
import { diag, DiagConsoleLogger, DiagLogLevel } from '@opentelemetry/api';
diag.setLogger(new DiagConsoleLogger(), DiagLogLevel.ERROR); // set diaglog level to DEBUG when debugging

const exporterOptions = {
  url: 'http://locahost:4318/v1/traces',
}

export const traceExporter = new OTLPTraceExporter(exporterOptions);
```

Create `instrumentation.ts`:
```ts:instrumentation.ts
import { registerOTel } from '@vercel/otel';
import { traceExporter } from './instrumentation.node';

export function register() {
  registerOTel({
    serviceName: '<service_name>',
    traceExporter: traceExporter,
  });
}
```

- `<service_name>` is name of your service

</TabItem>
<TabItem value="javascript" label="JavaScript">

Create `instrumentation.node.js`:
```js:instrumentation.node.js
'use strict'
const { OTLPTraceExporter } = require('@opentelemetry/exporter-trace-otlp-http');

// Add otel logging
const { diag, DiagConsoleLogger, DiagLogLevel } = require('@opentelemetry/api');
diag.setLogger(new DiagConsoleLogger(), DiagLogLevel.ERROR); // set diaglog level to DEBUG when debugging

const exporterOptions = {
  url: 'http://locahost:4318/v1/traces',
}

exports.traceExporter = new OTLPTraceExporter(exporterOptions);
```

Create `instrumentation.js`:
```js:instrumentation.js
const { registerOTel } = require('@vercel/otel');
const { traceExporter } = require('./instrumentation.node');

exports.register = function() {
  registerOTel({
    serviceName: '<service_name>',
    traceExporter: traceExporter,
  });
}
```

- `<service_name>` is name of your service

</TabItem>
</Tabs>

**Step 3.** Once you're done configuring the exporter options, try running your application and validate if your application is sending traces to SigNoz cloud [here](#validating-instrumentation-by-checking-for-traces).

<Admonition>
The instrumentation file should be in the root of your project and not inside the app or pages directory. If you're using the src folder, then place the file inside src alongside pages and app.
</Admonition>

You can also check the sample application at this <a href = "https://github.com/SigNoz/sample-nextjs-app/tree/vercel-otel" rel="noopener noreferrer nofollow" target="_blank">GitHub repo</a>.

In case you encounter an issue where all applications do not get listed in the services section then please refer to the [troubleshooting section](#troubleshooting-your-installation).

#### Using OpenTelemetry instrument (only works for nodejs runtime)

**Step 1.** Install OpenTelemetry Collector binary

OTel Collector binary helps to collect logs, hostmetrics, resource and infra attributes. It is recommended to install Otel Collector binary to collect and send traces to SigNoz cloud. You can correlate signals and have rich contextual data through this way.

You can find instructions to install OTel Collector binary [here](https://signoz.io/docs/tutorial/kubernetes-infra-metrics/) in your Kubernetes cluster. 

**Step 2.** Install OpenTelemetry packages

```bash
npm i @opentelemetry/sdk-node
npm i @opentelemetry/auto-instrumentations-node
npm i @opentelemetry/exporter-trace-otlp-http
npm i @opentelemetry/resources
npm i @opentelemetry/semantic-conventions
```

**Step 3.** Update `next.config.mjs` to include instrumentationHook
```tsx
/** @type {import('next').NextConfig} */
const nextConfig = {
    // include instrumentationHook experimental feature
    experimental: {
        instrumentationHook: true,
    },
};

export default nextConfig;
```

<Tabs>
<TabItem value="typescript" label="TypeScript" default>

Create `instrumentation.ts`:
```ts:instrumentation.ts
export async function register() {
  if (process.env.NEXT_RUNTIME === 'nodejs') {
    await import('./instrumentation.node')
  }
}
```

Create `instrumentation.node.ts`:
```ts:instrumentation.node.ts
'use strict'
import process from 'process';
import {NodeSDK} from '@opentelemetry/sdk-node';
import { getNodeAutoInstrumentations } from '@opentelemetry/auto-instrumentations-node';
import { OTLPTraceExporter } from '@opentelemetry/exporter-trace-otlp-http'
import { Resource } from '@opentelemetry/resources'
import { SEMRESATTRS_SERVICE_NAME } from '@opentelemetry/semantic-conventions'
 
// Add otel logging when debugging
// import { diag, DiagConsoleLogger, DiagLogLevel } from '@opentelemetry/api';
// diag.setLogger(new DiagConsoleLogger(), DiagLogLevel.DEBUG);

const exporterOptions = {
  url: 'http://localhost:4318/v1/traces',
}

const traceExporter = new OTLPTraceExporter(exporterOptions);
const sdk = new NodeSDK({
  traceExporter,
  instrumentations: [getNodeAutoInstrumentations()],
    resource: new Resource({
    [SEMRESATTRS_SERVICE_NAME]: '<service_name>',
  }),
});

// initialize the SDK and register with the OpenTelemetry API
// this enables the API to record telemetry
sdk.start()

// gracefully shut down the SDK on process exit
process.on('SIGTERM', () => {
  sdk.shutdown()
    .then(() => console.log('Tracing terminated'))
    .catch((error) => console.log('Error terminating tracing', error))
    .finally(() => process.exit(0));
});
```

- `<service_name>` is name of your service

</TabItem>
<TabItem value="javascript" label="JavaScript">

Create `instrumentation.js`:
```js:instrumentation.js
exports.register = async function() {
  if (process.env.NEXT_RUNTIME === 'nodejs') {
    await require('./instrumentation.node')
  }
}
```

Create `instrumentation.node.js`:
```js:instrumentation.node.js
'use strict'
const process = require('process');
const {NodeSDK} = require('@opentelemetry/sdk-node');
const { getNodeAutoInstrumentations } = require('@opentelemetry/auto-instrumentations-node');
const { OTLPTraceExporter } = require('@opentelemetry/exporter-trace-otlp-http');
const { Resource } = require('@opentelemetry/resources');
const { SEMRESATTRS_SERVICE_NAME } = require('@opentelemetry/semantic-conventions');
 
// Add otel logging when debugging
// const { diag, DiagConsoleLogger, DiagLogLevel } = require('@opentelemetry/api');
// diag.setLogger(new DiagConsoleLogger(), DiagLogLevel.DEBUG);

const exporterOptions = {
  url: 'http://localhost:4318/v1/traces',
}

const traceExporter = new OTLPTraceExporter(exporterOptions);
const sdk = new NodeSDK({
  traceExporter,
  instrumentations: [getNodeAutoInstrumentations()],
    resource: new Resource({
    [SEMRESATTRS_SERVICE_NAME]: '<service_name>',
  }),
});

// initialize the SDK and register with the OpenTelemetry API
// this enables the API to record telemetry
sdk.start()

// gracefully shut down the SDK on process exit
process.on('SIGTERM', () => {
  sdk.shutdown()
    .then(() => console.log('Tracing terminated'))
    .catch((error) => console.log('Error terminating tracing', error))
    .finally(() => process.exit(0));
});
```

- `<service_name>` is name of your service

</TabItem>
</Tabs>

**Step 4.** Once we are done with the above configurations, you can run the collector service with the following command:
```bash
./otelcol-contrib --config ./config.yaml
```

**Step 5.** Start running your application and wait for few seconds to start receiving instrumentation data on the SigNoz Cloud. 

<Admonition>
The instrumentation file should be in the root of your project and not inside the app or pages directory. If you're using the src folder, then place the file inside src alongside pages and app.
</Admonition>

You can also check the sample application at this <a href = "https://github.com/SigNoz/sample-nextjs-app" rel="noopener noreferrer nofollow" target="_blank">GitHub repo</a>.
</TabItem>
</Tabs>
</TabItem>
<TabItem value="windows" label="Windows">

From Windows, there are two ways to send data to SigNoz Cloud.

- Send traces directly to SigNoz Cloud
  - [Using Vercel Otel](#send-traces-directly-to-signoz-cloud---using-vercel-otel) (recommended)
  - [Using OpenTelemetry Instrument](#send-traces-directly-to-signoz-cloud---opentelemetry-instrument-only-works-for-nodejs-runtime)
- Send traces via OTel Collector binary (recommended)
  - [Using Vercel Otel](#using-vercel-otel-3) (recommended)
  - [Using OpenTelemetry Instrument](#using-opentelemetry-instrument-only-works-for-nodejs-runtime-3)

#### Send traces directly to SigNoz Cloud - Using vercel otel

**Step 1.** Install OpenTelemetry packages

```bash
npm install @vercel/otel @opentelemetry/sdk-logs @opentelemetry/api-logs @opentelemetry/instrumentation @opentelemetry/exporter-trace-otlp-http
```

**Step 2.** Update `next.config.mjs` to include instrumentationHook
```tsx
/** @type {import('next').NextConfig} */
const nextConfig = {
    // include instrumentationHook experimental feature
    experimental: {
        instrumentationHook: true,
    },
};

export default nextConfig;
```

<Tabs>
<TabItem value="typescript" label="TypeScript" default>

Create `instrumentation.node.ts`:
```ts:instrumentation.node.ts
'use strict'
import { OTLPTraceExporter } from '@opentelemetry/exporter-trace-otlp-http';

// Add otel logging
import { diag, DiagConsoleLogger, DiagLogLevel } from '@opentelemetry/api';
diag.setLogger(new DiagConsoleLogger(), DiagLogLevel.ERROR); // set diaglog level to DEBUG when debugging

const exporterOptions = {
  url: 'https://ingest.<region>.signoz.cloud:443/v1/traces', // Set your own data region or set to http://localhost:4318/v1/traces if using selfhost SigNoz
  headers: { 'signoz-ingestion-key': '<your-ingestion-key>' }, // Set if you are using SigNoz Cloud
}

export const traceExporter = new OTLPTraceExporter(exporterOptions);
```

- Set the `<region>` to match your SigNoz Cloud [region](https://signoz.io/docs/ingestion/signoz-cloud/overview/#endpoint)
- Replace `<your-ingestion-key>` with your SigNoz [ingestion key](https://signoz.io/docs/ingestion/signoz-cloud/keys/)


Create `instrumentation.ts`:
```ts:instrumentation.ts
import { registerOTel } from '@vercel/otel';
import { traceExporter } from './instrumentation.node';

export function register() {
  registerOTel({
    serviceName: '<service_name>',
    traceExporter: traceExporter,
  });
}
```

- `<service_name>` is name of your service

</TabItem>
<TabItem value="javascript" label="JavaScript">

Create `instrumentation.node.js`:
```js:instrumentation.node.js
'use strict'
const { OTLPTraceExporter } = require('@opentelemetry/exporter-trace-otlp-http');

// Add otel logging
const { diag, DiagConsoleLogger, DiagLogLevel } = require('@opentelemetry/api');
diag.setLogger(new DiagConsoleLogger(), DiagLogLevel.ERROR); // set diaglog level to DEBUG when debugging

const exporterOptions = {
  url: 'https://ingest.<region>.signoz.cloud:443/v1/traces', // Set your own data region or set to http://localhost:4318/v1/traces if using selfhost SigNoz
  headers: { 'signoz-access-token': '<your-ingestion-key>' }, // Set if you are using SigNoz Cloud
}

exports.traceExporter = new OTLPTraceExporter(exporterOptions);
```

Create `instrumentation.js`:
```js:instrumentation.js
const { registerOTel } = require('@vercel/otel');
const { traceExporter } = require('./instrumentation.node');

exports.register = function() {
  registerOTel({
    serviceName: '<service_name>',
    traceExporter: traceExporter,
  });
}
```

</TabItem>
</Tabs>

- Set the `<region>` to match your SigNoz Cloud [region](https://signoz.io/docs/ingestion/signoz-cloud/overview/#endpoint)
- Replace `<your-ingestion-key>` with your SigNoz [ingestion key](https://signoz.io/docs/ingestion/signoz-cloud/keys/)
- `<service_name>` is name of your service
- replace `<your_run_command>` with the run command of your application

**Step 3.** Once you're done configuring the exporter options, try running your application and validate if your application is sending traces to SigNoz cloud [here](#validating-instrumentation-by-checking-for-traces).

<Admonition>
The instrumentation file should be in the root of your project and not inside the app or pages directory. If you're using the src folder, then place the file inside src alongside pages and app.
</Admonition>

You can also check the sample application at this <a href = "https://github.com/SigNoz/sample-nextjs-app/tree/vercel-otel" rel="noopener noreferrer nofollow" target="_blank">GitHub repo</a>.

#### Send traces directly to SigNoz Cloud - OpenTelemetry instrument (only works for nodejs runtime)

**Step 1.** Install the OpenTelemetry packages

```bash
npm i @opentelemetry/sdk-node
npm i @opentelemetry/auto-instrumentations-node
npm i @opentelemetry/exporter-trace-otlp-http
npm i @opentelemetry/resources
npm i @opentelemetry/semantic-conventions
```

**Step 2.** Update `next.config.mjs` to include instrumentationHook
```tsx
/** @type {import('next').NextConfig} */
const nextConfig = {
    // include instrumentationHook experimental feature
    experimental: {
        instrumentationHook: true,
    },
};

export default nextConfig;
```

**Step 3.** Create `instrumentation.ts` file<br></br>
```ts:instrumentation.ts
export async function register() {
  if (process.env.NEXT_RUNTIME === 'nodejs') {
    await import('./instrumentation.node')
  }
}
```

**Step 4.** Create `instrumentation.node.ts` file<br></br>
You need to configure the endpoint for SigNoz cloud in this file.

```ts:instrumentation.node.ts
'use strict'
import process from 'process';
import {NodeSDK} from '@opentelemetry/sdk-node';
import { getNodeAutoInstrumentations } from '@opentelemetry/auto-instrumentations-node';
import { OTLPTraceExporter } from '@opentelemetry/exporter-trace-otlp-http'
import { Resource } from '@opentelemetry/resources'
import { SEMRESATTRS_SERVICE_NAME } from '@opentelemetry/semantic-conventions'
 
// Add otel logging when debugging
// import { diag, DiagConsoleLogger, DiagLogLevel } from '@opentelemetry/api';
// diag.setLogger(new DiagConsoleLogger(), DiagLogLevel.DEBUG);

const exporterOptions = {
  url: 'https://ingest.<region>.signoz.cloud:443/v1/traces', // use your own data region 
  headers: { 'signoz-ingestion-key': '<your-ingestion-key>' }, // Use if you are using SigNoz Cloud
}

const traceExporter = new OTLPTraceExporter(exporterOptions);
const sdk = new NodeSDK({
  traceExporter,
  instrumentations: [getNodeAutoInstrumentations()],
    resource: new Resource({
    [SEMRESATTRS_SERVICE_NAME]: '<service_name>',
  }),
});

// initialize the SDK and register with the OpenTelemetry API
// this enables the API to record telemetry
sdk.start()

// gracefully shut down the SDK on process exit
process.on('SIGTERM', () => {
  sdk.shutdown()
    .then(() => console.log('Tracing terminated'))
    .catch((error) => console.log('Error terminating tracing', error))
    .finally(() => process.exit(0));
});
```

- Set the `<region>` to match your SigNoz Cloud [region](https://signoz.io/docs/ingestion/signoz-cloud/overview/#endpoint)
- Replace `<your-ingestion-key>` with your SigNoz [ingestion key](https://signoz.io/docs/ingestion/signoz-cloud/keys/)
- `<service_name>` is name of your service

OpenTelemetry Node SDK currently does not detect the headers from `.env` files as of today. Thatâ€™s why we need to include the variables in the `tracing.js` file itself or set it using Powershell:


**Step 5.** Once you're done configuring the exporter options, try running your application and validate if your application is sending traces to SigNoz cloud [here](#validating-instrumentation-by-checking-for-traces).

<Admonition>
The instrumentation file should be in the root of your project and not inside the app or pages directory. If you're using the src folder, then place the file inside src alongside pages and app.
</Admonition>

You can also check the sample application at this <a href = "https://github.com/SigNoz/sample-nextjs-app" rel="noopener noreferrer nofollow" target="_blank">GitHub repo</a>.

#### Send traces via OTel Collector binary

OTel Collector binary helps to collect logs, hostmetrics, resource and infra attributes. It is recommended to install Otel Collector binary to collect and send traces to SigNoz cloud. You can correlate signals and have rich contextual data through this way.

<Admonition>
  You can find instructions to install OTel Collector binary
  [here](https://signoz.io/docs/tutorial/opentelemetry-binary-usage-in-virtual-machine/) in your VM.
  Once you are done setting up your OTel Collector binary, you can follow the below steps for
  instrumenting your Javascript application.
</Admonition>


#### Using vercel otel

**Step 1.** Install OpenTelemetry packages

```bash
npm install @vercel/otel @opentelemetry/sdk-logs @opentelemetry/api-logs @opentelemetry/instrumentation @opentelemetry/exporter-trace-otlp-http
```

**Step 2.** Update `next.config.mjs` to include instrumentationHook
```tsx
/** @type {import('next').NextConfig} */
const nextConfig = {
    // include instrumentationHook experimental feature
    experimental: {
        instrumentationHook: true,
    },
};

export default nextConfig;
```

**Step 3.** Create `instrumentation.node.ts` file<br></br>
You need to configure the endpoint for SigNoz cloud in this file.

```ts:instrumentation.node.ts
'use strict'
import { OTLPTraceExporter } from '@opentelemetry/exporter-trace-otlp-http';

// Add otel logging
import { diag, DiagConsoleLogger, DiagLogLevel } from '@opentelemetry/api';
diag.setLogger(new DiagConsoleLogger(), DiagLogLevel.ERROR); // set diaglog level to DEBUG when debugging

const exporterOptions = {
  url: 'http://localhost:4318/v1/traces',
}

export const traceExporter = new OTLPTraceExporter(exporterOptions);
```

**Step 4.** Create `instrumentation.ts` file<br></br>
```ts:instrumentation.ts
import { registerOTel } from '@vercel/otel';
import { traceExporter } from './instrumentation.node';

export function register() {
  registerOTel({
    serviceName: '<service_name>',
    traceExporter: traceExporter,
  });
}
```

- `<service_name>` is name of your service

**Step 5.** Once you're done configuring the exporter options, try running your application and validate if your application is sending traces to SigNoz cloud [here](#validating-instrumentation-by-checking-for-traces).

<Admonition>
The instrumentation file should be in the root of your project and not inside the app or pages directory. If you're using the src folder, then place the file inside src alongside pages and app.
</Admonition>

You can also check the sample application at this <a href = "https://github.com/SigNoz/sample-nextjs-app/tree/vercel-otel" rel="noopener noreferrer nofollow" target="_blank">GitHub repo</a>.

#### Using OpenTelemetry instrument (only works for nodejs runtime)

**Step 1.** Install OpenTelemetry Collector binary

OTel Collector binary helps to collect logs, hostmetrics, resource and infra attributes. It is recommended to install Otel Collector binary to collect and send traces to SigNoz cloud. You can correlate signals and have rich contextual data through this way.

You can find instructions to install OTel Collector binary [here](https://signoz.io/docs/tutorial/opentelemetry-binary-usage-in-virtual-machine/) in your VM. 

While creating the `config.yaml` during the installation fo the OTel Collector Binary, you need to enable CORS under the receivers section of the config file. This is needed so that you don't get 
CORS error which can hinder sending your Traces to SigNoz Cloud. See the code snippet below to understand how you can enable CORS in your config file:

```yml
      http:
+        cors:
+          allowed_origins:
+            - <Frontend-application-URL>  # URL of your Frontend application. Example -> http://localhost:4200, https://netflix.com etc.
```
`<Frontend-application-URL>` - URL where your frontend application is running. For Example, http://localhost:4200 or https://netflix.com etc.

**NOTE:** Make sure to restart your collector after making the config changes

**Step 2.** Install OpenTelemetry packages

```bash
npm i @opentelemetry/sdk-node
npm i @opentelemetry/auto-instrumentations-node
npm i @opentelemetry/exporter-trace-otlp-http
npm i @opentelemetry/resources
npm i @opentelemetry/semantic-conventions
```

**Step 3.** Update `next.config.mjs` to include instrumentationHook
```tsx
/** @type {import('next').NextConfig} */
const nextConfig = {
    // include instrumentationHook experimental feature
    experimental: {
        instrumentationHook: true,
    },
};

export default nextConfig;
```

**Step 4.** Create `instrumentation.ts` file<br></br>
```ts:instrumentation.ts
export async function register() {
  if (process.env.NEXT_RUNTIME === 'nodejs') {
    await import('./instrumentation.node')
  }
}
```

**Step 5.** Create `instrumentation.node.ts` file<br></br>
You need to configure the endpoint for SigNoz cloud in this file.

```ts:instrumentation.node.ts
'use strict'
import process from 'process';
import {NodeSDK} from '@opentelemetry/sdk-node';
import { getNodeAutoInstrumentations } from '@opentelemetry/auto-instrumentations-node';
import { OTLPTraceExporter } from '@opentelemetry/exporter-trace-otlp-http'
import { Resource } from '@opentelemetry/resources'
import { SEMRESATTRS_SERVICE_NAME } from '@opentelemetry/semantic-conventions'
 
// Add otel logging when debugging
// import { diag, DiagConsoleLogger, DiagLogLevel } from '@opentelemetry/api';
// diag.setLogger(new DiagConsoleLogger(), DiagLogLevel.DEBUG);

const exporterOptions = {
  url: 'http://localhost:4318/v1/traces',
}

const traceExporter = new OTLPTraceExporter(exporterOptions);
const sdk = new NodeSDK({
  traceExporter,
  instrumentations: [getNodeAutoInstrumentations()],
    resource: new Resource({
    [SEMRESATTRS_SERVICE_NAME]: '<service_name>',
  }),
});

// initialize the SDK and register with the OpenTelemetry API
// this enables the API to record telemetry
sdk.start()

// gracefully shut down the SDK on process exit
process.on('SIGTERM', () => {
  sdk.shutdown()
    .then(() => console.log('Tracing terminated'))
    .catch((error) => console.log('Error terminating tracing', error))
    .finally(() => process.exit(0));
});
```

- `<service_name>` is name of your service

**Step 6.** Once we are done with the above configurations, you can run the collector service with the following command:
```bash
./otelcol-contrib --config ./config.yaml
```

**Step 7.** Start running your application and wait for few seconds to start receiving instrumentation data on the SigNoz Cloud. 

<Admonition>
The instrumentation file should be in the root of your project and not inside the app or pages directory. If you're using the src folder, then place the file inside src alongside pages and app.
</Admonition>

You can also check the sample application at this <a href = "https://github.com/SigNoz/sample-nextjs-app" rel="noopener noreferrer nofollow" target="_blank">GitHub repo</a>.

</TabItem>

</Tabs>

</TabItem>
<TabItem value='self-host' label='Self-Host'>

## Send traces to SigNoz Self-Host

If you're trying to send instrumentation data to SigNoz self-hosted way, the only minor thing (apart from installing OpenTelemetry packages) that you'd be required is to change the `exporterOptions` in the `tracing.js` file

You can find instructions to install OTel Collector binary [here](https://signoz.io/docs/tutorial/kubernetes-infra-metrics/) in your Kubernetes cluster. 

### Using vercel otel

**Step 1.** Install OpenTelemetry packages

```bash
npm install @vercel/otel @opentelemetry/sdk-logs @opentelemetry/api-logs @opentelemetry/instrumentation @opentelemetry/exporter-trace-otlp-http
```

**Step 2.** Update `next.config.mjs` to include instrumentationHook
```tsx
/** @type {import('next').NextConfig} */
const nextConfig = {
    // include instrumentationHook experimental feature
    experimental: {
        instrumentationHook: true,
    },
};

export default nextConfig;
```

**Step 3.** Create `instrumentation.node.ts` file<br></br>
You need to configure the endpoint for SigNoz cloud in this file.
<Tabs>
<TabItem value="typescript" label="TypeScript" default>
```ts:instrumentation.node.ts
'use strict'
import { OTLPTraceExporter } from '@opentelemetry/exporter-trace-otlp-http';

// Add otel logging
import { diag, DiagConsoleLogger, DiagLogLevel } from '@opentelemetry/api';
diag.setLogger(new DiagConsoleLogger(), DiagLogLevel.ERROR); // set diaglog level to DEBUG when debugging

const exporterOptions = {
  url: 'http://localhost:4318/v1/traces', // Endpoint of SigNoz/Otel Collector
}

export const traceExporter = new OTLPTraceExporter(exporterOptions);
```
</TabItem>
<TabItem value="javascript" label="JavaScript">
```javascript
'use strict'
const { OTLPTraceExporter } = require('@opentelemetry/exporter-trace-otlp-http');

// Add otel logging
const { diag, DiagConsoleLogger, DiagLogLevel } = require('@opentelemetry/api');
diag.setLogger(new DiagConsoleLogger(), DiagLogLevel.ERROR); // set diaglog level to DEBUG when debugging

const exporterOptions = {
  url: 'http://localhost:4318/v1/traces', // Endpoint of SigNoz/Otel Collector
}

exports.traceExporter = new OTLPTraceExporter(exporterOptions);

```
</TabItem>
</Tabs>

**Step 4.** Create `instrumentation.ts` file<br></br>
<Tabs>
<TabItem value="typescript" label="TypeScript" default>
```ts:instrumentation.ts
import { registerOTel } from '@vercel/otel';
import { traceExporter } from './instrumentation.node';

export function register() {
  registerOTel({
    serviceName: '<service_name>',
    traceExporter: traceExporter,
  });
}
```
</TabItem>
<TabItem value="javascript" label="JavaScript">
```javascript
const { registerOTel } = require('@vercel/otel');
const { traceExporter } = require('./instrumentation.node');

exports.register = function() {
  registerOTel({
    serviceName: '<service_name>',
    traceExporter: traceExporter,
  });
}
```
</TabItem>
</Tabs>


- `<service_name>` is name of your service

**Step 5.** Once you're done configuring the exporter options, try running your application and validate if your application is sending traces to SigNoz cloud [here](#validating-instrumentation-by-checking-for-traces).

<Admonition>
The instrumentation file should be in the root of your project and not inside the app or pages directory. If you're using the src folder, then place the file inside src alongside pages and app.
</Admonition>

You can also check the sample application at this <a href = "https://github.com/SigNoz/sample-nextjs-app/tree/vercel-otel" rel="noopener noreferrer nofollow" target="_blank">GitHub repo</a>.

### Using OpenTelemetry instrument (only works for nodejs runtime)

**Step 1.** Install OpenTelemetry packages

```bash
npm i @opentelemetry/sdk-node
npm i @opentelemetry/auto-instrumentations-node
npm i @opentelemetry/exporter-trace-otlp-http
npm i @opentelemetry/resources
npm i @opentelemetry/semantic-conventions
```

**Step 2.** Update `next.config.mjs` to include instrumentationHook
```tsx
/** @type {import('next').NextConfig} */
const nextConfig = {
    // include instrumentationHook experimental feature
    experimental: {
        instrumentationHook: true,
    },
};

export default nextConfig;
```
**Step 3.** Create `instrumentation.ts` file.<br></br>
<Tabs>
<TabItem value="typescript" label="TypeScript" default>
```tsx:instrumentation.ts
export async function register() {
  if (process.env.NEXT_RUNTIME === 'nodejs') {
    await import('./instrumentation.node')
  }
}
```
</TabItem>
<TabItem value="javascript" label="JavaScript">
```javascript
module.exports = {
  register: async function() {
    if (process.env.NEXT_RUNTIME === 'nodejs') {
      await import('./instrumentation.node')
    }
  }
}
```
</TabItem>
</Tabs>

**Step 4.** Create `instrumentation.node.ts` file<br></br>
You need to configure the endpoint for SigNoz cloud in this file.
<Tabs>
<TabItem value="typescript" label="TypeScript" default>
```ts:instrumentation.node.ts
'use strict'
import process from 'process';
import {NodeSDK} from '@opentelemetry/sdk-node';
import { getNodeAutoInstrumentations } from '@opentelemetry/auto-instrumentations-node';
import { OTLPTraceExporter } from '@opentelemetry/exporter-trace-otlp-http'
import { Resource } from '@opentelemetry/resources'
import { SEMRESATTRS_SERVICE_NAME } from '@opentelemetry/semantic-conventions'
 
// Add otel logging when debugging
// import { diag, DiagConsoleLogger, DiagLogLevel } from '@opentelemetry/api';
// diag.setLogger(new DiagConsoleLogger(), DiagLogLevel.DEBUG);

const exporterOptions = {
  url: 'http://localhost:4318/v1/traces',
}

const traceExporter = new OTLPTraceExporter(exporterOptions);
const sdk = new NodeSDK({
  traceExporter,
  instrumentations: [getNodeAutoInstrumentations()],
    resource: new Resource({
    [SEMRESATTRS_SERVICE_NAME]: '<service_name>',
  }),
});

// initialize the SDK and register with the OpenTelemetry API
// this enables the API to record telemetry
sdk.start()

// gracefully shut down the SDK on process exit
process.on('SIGTERM', () => {
  sdk.shutdown()
    .then(() => console.log('Tracing terminated'))
    .catch((error) => console.log('Error terminating tracing', error))
    .finally(() => process.exit(0));
});
```
</TabItem>
<TabItem value="javascript" label="JavaScript">
```javascript
'use strict'
const process = require('process');
const {NodeSDK} = require('@opentelemetry/sdk-node');
const { getNodeAutoInstrumentations } = require('@opentelemetry/auto-instrumentations-node');
const { OTLPTraceExporter } = require('@opentelemetry/exporter-trace-otlp-http');
const { Resource } = require('@opentelemetry/resources');
const { SEMRESATTRS_SERVICE_NAME } = require('@opentelemetry/semantic-conventions');

// Add otel logging
const { diag, DiagConsoleLogger, DiagLogLevel } = require('@opentelemetry/api');
diag.setLogger(new DiagConsoleLogger(), DiagLogLevel.ERROR); // set diaglog level to DEBUG when debugging

const exporterOptions = {
  url: 'http://localhost:4318/v1/traces',
}

const traceExporter = new OTLPTraceExporter(exporterOptions);
const sdk = new NodeSDK({
  traceExporter,
  instrumentations: [getNodeAutoInstrumentations()],
});

// initialize the SDK and register with the OpenTelemetry API
// this enables the API to record telemetry
sdk.start()

// gracefully shut down the SDK on process exit
process.on('SIGTERM', () => {
  sdk.shutdown()
    .then(() => console.log('Tracing terminated'))
    .catch((error) => console.log('Error terminating tracing', error))
    .finally(() => process.exit(0));
});
```
</TabItem>
</Tabs>


<Admonition>
The instrumentation file should be in the root of your project and not inside the app or pages directory. If you're using the src folder, then place the file inside src alongside pages and app.
</Admonition>

Again, `http://localhost:4318/v1/traces` is the default url for sending your tracing data. We are assuming you have installed SigNoz on your localhost. Based on your environment, you can update it accordingly. It should be in the following format:

`http://<IP of SigNoz backend>:4318/v1/traces`

**NOTE:** Remember to allow incoming requests to port 4318 of machine where SigNoz backend is hosted.

Once you're done with this, add your required changes including receivers, exporters in the `config.yml` file which can be generally found [here](https://github.com/SigNoz/signoz/blob/main/deploy/docker/otel-collector-config.yaml).

**Step 5.** Once you're done configuring the exporter options, try running your application and validate if your application is sending traces to SigNoz [here](#validating-instrumentation-by-checking-for-traces).

You can also check the sample application at this <a href = "https://github.com/SigNoz/sample-nextjs-app" rel="noopener noreferrer nofollow" target="_blank">GitHub repo</a>.

</TabItem>
</Tabs>

## Validating instrumentation by checking for traces

With your application running, you can verify that youâ€™ve instrumented your application with OpenTelemetry correctly by confirming that tracing data is being reported to SigNoz.

To do this, you need to ensure that your application generates some data. Applications will not produce traces unless they are being interacted with, and OpenTelemetry will often buffer data before sending. So you need to interact with your application and wait for some time to see your tracing data in SigNoz.

Validate your traces in SigNoz:

1. Trigger an action in your app that generates a web request. Hit the endpoint a number of times to generate some data. Then, wait for some time.
2. In SigNoz, open the `Services` tab. Hit the `Refresh` button on the top right corner, and your application should appear in the list of `Applications`.
3. Go to the `Traces` tab, and apply relevant filters to see your applicationâ€™s traces.

{/* You might see other dummy applications if youâ€™re using SigNoz for the first time. You can remove it by following the docs [here](https://signoz.io/docs/operate/docker-standalone/#remove-the-sample-application). */}

{/* <figure data-zoomable align='center'>
    <img src="/img/docs/nextjs_application_instrumentation.webp" alt="Nextjs Application in the list of services being monitored in SigNoz"/>
    <figcaption><i>Nextjs Application in the list of services being monitored in SigNoz</i></figcaption>
</figure> */}

{/* ## Conclusion

OpenTelemetry is the future for setting up observability for cloud-native apps. It is backed by a huge community and covers a wide variety of technology and frameworks. Using OpenTelemetry, engineering teams can instrument polyglot and distributed applications and be assured about compatibility with a lot of technologies.

SigNoz is an open-source observability tool that comes with a SaaS-like experience. You can check out SigNoz by visiting its GitHub repo ðŸ‘‡

[![SigNoz GitHub repo](/img/blog/common/signoz_github.webp)](https://github.com/SigNoz/signoz)

If you are someone who understands more from video, then you can watch the below video tutorial on the same with SigNoz.

{/* <YouTube id="sC1xNIcItTM" mute={false} /> */}

If you face any issues while trying out SigNoz, you can reach out with your questions in #support channel ðŸ‘‡

[![SigNoz Slack community](/img/blog/common/join_slack_cta.webp)](https://signoz.io/slack)

**Further Reading**

[Implementing OpenTelemetry in Angular application](https://signoz.io/blog/opentelemetry-angular/)

[Monitor your Nodejs application with OpenTelemetry and SigNoz](https://signoz.io/opentelemetry/nodejs/)